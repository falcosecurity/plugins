name: Update OCI Artifacts
on:
  workflow_dispatch # to be set to cron

jobs:
  publish-oci-artifacts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Plugins
        uses: actions/checkout@v3

      - name: Setup Golang
        uses: actions/setup-go@v3
        with:
          go-version: '^1.19'

      - name: Build registry artifact tool
        working-directory: build/registry
        run: make

      - name: Upload OCI artifacts to GitHub packages
        env:
          REGISTRY: ghcr.io
          REGISTRY_USER: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_GITHUB: https://github.com/loresuso/plugins.git # change this
        working-directory: build/registry
        run: ./bin/registry update-oci-registry ../../registry.yaml

      # THIS NEED TO BE IMPLEMENTED IN PROW
      # - name: Generate index
      #   env: 
      #     REGISTRY: ghcr.io
      #     REGISTRY_USER: ${{ github.actor }}
      #   working-directory: build/registry
      #   run: | 
      #       ./bin/registry update-index ../../registry.yaml newIndex.yaml && 
      #       cat newIndex.yaml && 
      #       mkdir /tmp/index &&
      #       mv newIndex.yaml /tmp/index/index.yaml 
      
      # - name: Publish on GitHub Pages
      #   uses: ftnext/action-push-ghpages@v1.0.0
      #   with:
      #     build_dir: /tmp/index
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
