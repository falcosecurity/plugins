# This is a reusable workflow used by main and release CI
on:
  workflow_call:
    inputs:
      makecommand:
        description: Command used for make
        required: true
        type: string
      suffix:
        description: Suffix for uploading packages (dev or stable)
        required: true
        type: string

jobs:
  build-packages:
    name: build-packages-${{ matrix.arch }}
    runs-on: ${{ (matrix.arch == 'aarch64' && 'ubuntu-22.04-arm') || 'ubuntu-22.04' }}
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    # Upgrading to a newer debian version would make the build process generate
    # binaries that require newer GLIBC version so we need to be based on bullseye for now
    container: debian:bullseye
    steps:
      - name: Install deps
        run: |
          apt update
          apt install -y --no-install-recommends awscli build-essential autoconf libelf-dev libtool autotools-dev \
            automake zip unzip ninja-build wget lsb-release software-properties-common gnupg ca-certificates curl git

      - name: Checkout Plugins ‚§µÔ∏è
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          submodules: "recursive"

      - name: Safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.25'

      - name: Install updated clang version ‚õìÔ∏è
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod u+x llvm.sh
          ./llvm.sh 19
          ln -s /usr/bin/clang-19 /usr/bin/clang

      - name: Install updated cmake version ‚õìÔ∏è
        uses: ./.github/actions/install-cmake

      - name: Install Rust ü¶Ä
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: "1.88.0"

      - name: Install bpf-linker
        run: |
          cargo install bpf-linker@0.9.14

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 #v2

      - name: Run build üèóÔ∏è
        run: ${{ inputs.makecommand }}

      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: plugins-${{ matrix.arch }}-${{ inputs.suffix }}.tar.gz
          path: output/*.tar.gz
