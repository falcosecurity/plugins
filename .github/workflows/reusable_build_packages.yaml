# This is a reusable workflow used by main and release CI
on:
  workflow_call:
    inputs:
      makecommand:
        description: Command used for make
        required: true
        type: string
      suffix:
        description: Suffix for uploading packages (dev or stable)
        required: true
        type: string

jobs:
  build-packages:
    name: build-packages-${{ matrix.arch }}
    runs-on: ${{ (matrix.arch == 'aarch64' && 'ubuntu-22.04-arm') || 'ubuntu-22.04' }}
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    # Upgrading to a newer debian version would make the build process generate
    # binaries that require newer GLIBC version so we need to be based on bullseye for now
    container: golang:1.24-bullseye
    steps:
      - name: Install deps
        run: |
          apt update
          apt install -y --no-install-recommends awscli build-essential autoconf libelf-dev libtool autotools-dev \
            automake zip unzip ninja-build wget lsb-release software-properties-common gnupg

      - name: Install updated clang version ‚õìÔ∏è
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod u+x llvm.sh
          ./llvm.sh 19
          ln -s /usr/bin/clang-19 /usr/bin/clang

      - name: Install updated cmake version ‚õìÔ∏è
        run: |
          curl -L -o /tmp/cmake.tar.gz https://github.com/Kitware/CMake/releases/download/v3.31.4/cmake-3.31.4-linux-$(uname -m).tar.gz
          gzip -d /tmp/cmake.tar.gz
          tar -xpf /tmp/cmake.tar --directory=/tmp
          cp -R /tmp/cmake-3.31.4-linux-$(uname -m)/* /usr
          rm -rf /tmp/cmake-3.31.4-linux-$(uname -m)

      - name: Install Rust ü¶Ä
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: "1.86.0"

      - name: Install bpf-linker
        run: |
          cargo install bpf-linker@0.9.14

      - name: Configure Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 #v2

      - name: Checkout Plugins ‚§µÔ∏è
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          submodules: "recursive"

      - name: Safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Run build üèóÔ∏è
        run: ${{ inputs.makecommand }}

      - name: Upload artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: plugins-${{ matrix.arch }}-${{ inputs.suffix }}.tar.gz
          path: output/*.tar.gz
